<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat - Sanuyo</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">

<style>
    body {
        font-family: 'Poppins', sans-serif;
        margin: 0;
        background: #eee;
    }

    /* Header */
    header {
        background: #6A0DAD;
        padding: 15px;
        color: white;
        font-size: 18px;
        font-weight: 600;
        position: sticky;
        top: 0;
        z-index: 10;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    header img {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        background: white;
        object-fit: cover;
    }

    /* Messages Area */
    #messages {
        padding: 10px;
        height: calc(100vh - 130px);
        overflow-y: auto;
        display: flex;
        flex-direction: column;
    }

    .msg {
        max-width: 80%;
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 10px;
        font-size: 14px;
        line-height: 1.4;
    }

    .me {
        background: #6A0DAD;
        color: white;
        align-self: flex-end;
        border-bottom-right-radius: 0;
    }

    .them {
        background: white;
        color: #333;
        align-self: flex-start;
        border-bottom-left-radius: 0;
    }

    /* Input Bar */
    .inputBar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        padding: 10px;
        display: flex;
        gap: 10px;
        border-top: 1px solid #ddd;
    }

    .inputBar input {
        flex: 1;
        padding: 12px;
        border: 1px solid #ccc;
        border-radius: 20px;
        outline: none;
        font-size: 14px;
    }

    .inputBar button {
        background: #6A0DAD;
        border: none;
        padding: 12px 18px;
        border-radius: 20px;
        color: white;
        font-weight: 600;
        cursor: pointer;
    }
</style>
</head>

<body>

<header>
    <img id="avatar" src="https://via.placeholder.com/40">
    <div id="chatName">Chat</div>
</header>

<div id="messages"></div>

<div class="inputBar">
    <input type="text" id="msgInput" placeholder="Type a message...">
    <button onclick="sendMessage()">Send</button>
</div>

<!-- Firebase -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { 
        getFirestore, collection, addDoc, orderBy, onSnapshot, query, serverTimestamp 
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDcSCU5TIout3oQm1ADYISmuf3M1--1JLY",
      authDomain: "sanuyo-website.firebaseapp.com",
      projectId: "sanuyo-website",
      storageBucket: "sanuyo-website.firebasestorage.app",
      messagingSenderId: "765213630366",
      appId: "1:765213630366:web:03279e61a58289b088808f"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // GET CHAT ID FROM URL
    const urlParams = new URLSearchParams(window.location.search);
    const chatId = urlParams.get("chat");

    const USER_ID = "demoUser1"; // Replace after authentication
    let otherUser = "Seller";

    // CHAT UI SETUP
    document.getElementById("chatName").innerText = "Loading...";

    // Real-time Message Listener
    function loadMessages() {
        const messagesRef = collection(db, "chats", chatId, "messages");
        const q = query(messagesRef, orderBy("timestamp"));

        onSnapshot(q, (snapshot) => {
            const container = document.getElementById("messages");
            container.innerHTML = "";

            snapshot.forEach(doc => {
                const msg = doc.data();
                const bubble = document.createElement("div");

                bubble.className = "msg " + (msg.senderId === USER_ID ? "me" : "them");
                bubble.innerText = msg.text;

                container.appendChild(bubble);
            });

            // Auto scroll to bottom
            container.scrollTop = container.scrollHeight;
        });
    }

    loadMessages();

    // Send message
    async function sendMessage() {
        const input = document.getElementById("msgInput");
        const text = input.value.trim();
        if (!text) return;

        await addDoc(collection(db, "chats", chatId, "messages"), {
            senderId: USER_ID,
            text: text,
            timestamp: serverTimestamp()
        });

        input.value = "";
    }
</script>

</body>
</html>
